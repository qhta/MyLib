<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:helpers="clr-namespace:Qhta.UnicodeBuild.Helpers"
                    xmlns:converters="clr-namespace:Qhta.WPF.Converters;assembly=Qhta.WPF.Converters"
                    xmlns:viewModels="clr-namespace:Qhta.UnicodeBuild.ViewModels"
                    xmlns:sf="http://schemas.syncfusion.com/wpf"
                    xmlns:mvvm="clr-namespace:Qhta.MVVM;assembly=Qhta.MVVM"
                    x:Class="Qhta.UnicodeBuild.AppResourceDictionary">

  <helpers:ViewModelsBindingProxy x:Key="ViewModels"/>
  <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
  <converters:BoolToTextWrappingConverter x:Key="BoolToTextWrappingConverter"/>
  <helpers:MappingNameToValueConverter x:Key="MappingNameToValueConverter"/>
  <helpers:MappingNameBinder x:Key="MappingNameBinder"/>
  <helpers:RangeModelComparer x:Key="RangeModelComparer"/>
  <helpers:RangeModelValueConverter x:Key="RangeModelValueConverter"/>
  <converters:NegateValueConverter x:Key="NegateValueConverter"/>

  <ContextMenu x:Key="CommonContextMenu">
    <MenuItem Header="Copy" Command="Copy"/>
    <MenuItem Header="Paste" Command="Paste"/>
    <MenuItem Header="Cut" Command="Cut"/>
  </ContextMenu>

  <Style TargetType="TextBox">
    <Setter Property="Validation.ErrorTemplate">
      <Setter.Value>
        <ControlTemplate>
          <DockPanel>
            <Border DockPanel.Dock="Bottom" Background="Red" BorderBrush="Black" BorderThickness="1"
                    Padding="2">
              <TextBlock Foreground="White" Text="{Binding [0].ErrorContent}" />
            </Border>
            <AdornedElementPlaceholder />
          </DockPanel>
        </ControlTemplate>
      </Setter.Value>
    </Setter>
    <Style.Triggers>
      <Trigger Property="Validation.HasError" Value="True">
        <Setter Property="ToolTip" Value="{Binding RelativeSource={RelativeSource Self}, Path=(Validation.Errors)[0].ErrorContent}" />
      </Trigger>
    </Style.Triggers>
  </Style>

  <DataTemplate x:Key="RangeCellTemplate">
    <TextBlock 
        Text="{Binding Range, Converter={StaticResource RangeModelValueConverter}}" 
        Padding="3"/>
  </DataTemplate>
  <DataTemplate x:Key="RangeEditTemplate">
    <TextBox >
      <TextBox.Text>
        <Binding Path="Range" 
                   Converter="{StaticResource RangeModelValueConverter}"
                   UpdateSourceTrigger="PropertyChanged"
                   Mode="TwoWay">
          <Binding.ValidationRules>
            <helpers:RangeValidationRule />
          </Binding.ValidationRules>
        </Binding>
      </TextBox.Text>
    </TextBox>

  </DataTemplate>

  <DataTemplate x:Key="TextCellTemplate" DataType="{x:Type mvvm:IViewModel}">
    <TextBlock      
      Text="{Binding Path=TemplatedParent, 
      RelativeSource={RelativeSource AncestorType=ContentPresenter}, 
      Converter={StaticResource MappingNameToValueConverter}}"
      Padding="2"
      ContextMenu="{StaticResource CommonContextMenu}" 
      />
  </DataTemplate>

  <DataTemplate x:Key="LongTextCellTemplate" DataType="{x:Type viewModels:ILongTextViewModel}">
    <Grid>
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="Auto"/>
      </Grid.ColumnDefinitions>
      <TextBlock 
        x:Name="LongTextBlock"
        Text="{Binding Path=LongText}" 
        Padding="3"
        TextWrapping="Wrap"
        />
      <Button 
        Grid.Column="1"
        Visibility="{Binding CanExpandLongText, 
          Converter={StaticResource BoolToVisibilityConverter}}"
        Height="20"
        VerticalAlignment="Top"
        Background="Transparent"
        BorderThickness="0"
        BorderBrush="Transparent"
        Content="▼"
        Click="ShowPopup_Click"/>
      <Popup Grid.Column="0" Grid.ColumnSpan="2" x:Name="LongTextPopup" Placement="Mouse" StaysOpen="false">
        <Border Background="LightGray" BorderBrush="Black" BorderThickness="1" Padding="3" 
                >
          <TextBlock 
            Text="{Binding Path=LongText}" 
            TextWrapping="Wrap"/>
        </Border>
      </Popup>
    </Grid>
  </DataTemplate>

  <DataTemplate x:Key="LongTextEditTemplate" DataType="{x:Type viewModels:ILongTextViewModel}">
    <Grid x:Name="EditedGrid">
      <TextBlock 
        Text="{Binding Path=LongText}" 
        Padding="3"
        TextWrapping="Wrap"/>
      <Popup 
         x:Name="LongTextEditPopup" 
         PlacementTarget="{Binding 
           RelativeSource={RelativeSource AncestorType={x:Type Grid}},
           BindsDirectlyToSource=true}"
         Placement = "Bottom"
         VerticalOffset="{Binding
           RelativeSource={RelativeSource AncestorType={x:Type Grid}},
           Path=ActualHeight,
           Converter = {StaticResource NegateValueConverter}}"
         Width="{Binding
           RelativeSource={RelativeSource AncestorType={x:Type Grid}},
           Path=ActualWidth}"
         IsOpen = "true"   
         StaysOpen="false">
        <Border Background="White" BorderBrush="Black" BorderThickness="1" Padding="3" 
        >
          <TextBox 
            Text="{Binding Path=LongText}" 
            BorderThickness="0"
            BorderBrush="Transparent"
            TextWrapping="Wrap"
            AcceptsReturn="True"
            sf:FocusManagerHelper.FocusedElement ="True"
            />
        </Border>
      </Popup>
    </Grid>
  </DataTemplate>
</ResourceDictionary>